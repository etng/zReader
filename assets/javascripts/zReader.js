// Generated by CoffeeScript 1.6.2
jQuery(function() {
  var App, AppRouter, AppStorage, Article, ArticleList, ArticleView, Feed, FeedList, FeedView, IndexItemView, IndexListView, Label, LabelList, LabelView, LabelsView, buildUrlHash, mergeDelta;

  mergeDelta = function(delta) {
    var field;

    for (field in delta) {
      delta = delta[field];
      if (_.has(this, field)) {
        this[field] = this.field + delta;
      }
    }
    return this;
  };
  _.mixin({
    diff: function(a, b) {
      return {
        removed: _.difference(b, a),
        added: _.difference(a, b)
      };
    },
    truncate: function(s, limit) {
      var c, l, m, n;

      if (!limit || limit <= 0) {
        limit = 280;
      }
      l = s.length;
      if (l > limit / 2) {
        m = 0;
        n = 0;
        while (m < l && n < limit) {
          m++;
          c = s.charCodeAt(m);
          n++;
          if (c > 256 || c < 0) {
            n++;
          }
        }
        if (m < l) {
          return s.substring(0, m) + "...";
        }
      }
      return s;
    },
    prettyDate: function(time) {
      var days, seconds;

      seconds = (new Date().getTime() - new Date(time).getTime()) / 1000;
      days = Math.floor(seconds / 86400);
      if (isNaN(days) || days < 0) {
        return;
      }
      if (days === 0) {
        if (seconds < 60) {
          return "moments ago";
        } else if (seconds < 3600) {
          return "" + (Math.floor(seconds / 60)) + " minutes ago";
        } else {
          return "" + (Math.floor(seconds / 3600)) + " hours ago";
        }
      } else if (days === 1) {
        return "Yesterday";
      } else if (days < 7) {
        return "" + days + " days ago";
      } else if (days < 31) {
        return "" + (Math.ceil(days / 7)) + " weeks ago";
      } else if (days < 365) {
        return "" + (Math.ceil(days / 30.5)) + " months ago";
      } else {
        return "" + (Math.ceil(days / 365)) + " years ago";
      }
    }
  });
  _.templateSettings = {
    interpolate: /\<\@\=(.+?)\@\>/gim,
    evaluate: /\<\@(.+?)\@\>/gim,
    escape: /\<\@\-(.+?)\@\>/gim
  };
  Feed = Backbone.Model.extend({
    defaults: {
      unread: 0,
      all: 0,
      starred: 0,
      markasread: 0,
      read: 0,
      title: '',
      mute: false
    },
    initialize: function() {
      var stat_fields,
        _this = this;

      stat_fields = {
        unread: App._('unread'),
        all: App._('all'),
        starred: App._('starred'),
        markasread: App._('markasread'),
        read: App._('read')
      };
      return this.on('change', function() {
        var delta, field, label;

        delta = {};
        for (field in stat_fields) {
          label = stat_fields[field];
          delta[field] = _this.get(field) - _this.previous(field);
        }
        App.storage.allLabel.mergeDelta(delta);
        if (model.mute) {
          Appl.storage.mutesLabel.mergeDelta(delta);
        }
        if (model.get('categories') && model.get('categories').length) {
          return _.each(model.get('categories'), function(category) {
            App.storage.labels.get(category).mergeDelta(delta);
          });
        } else {
          return App.storage.othersLabel.mergeDelta(delta);
        }
      });
    },
    mergeDelta: mergeDelta,
    removeLabel: function(label) {
      var _this = this;

      if (App.storage.labels.get(label).isLocked()) {
        return;
      }
      return $.ajax({
        url: "/reader/api/0/disable-tag?ck=" + ($.now()),
        type: 'POST',
        data: {
          "s": label
        }
      }).done(function(data) {
        var categories;

        categories = _this.get('categories');
        categories.splice(categories.indexOf(label), 1);
        _this.set('categories');
      });
    },
    markasread: function() {
      App.storage.mark(this, 'markasread');
    },
    getSortRank: function() {
      var field, rank, rank_weight, weight;

      rank_weight = {
        markasread: -1,
        read: 2,
        starred: 5
      };
      rank = 0;
      for (field in rank_weight) {
        weight = rank_weight[field];
        rank += this.get(field) * weight;
      }
      return rank;
    }
  });
  Label = Backbone.Model.extend({
    "default": function() {},
    lock: function() {
      return this.locked = true;
    },
    isLocked: function() {
      return this.locked;
    },
    mergeDelta: mergeDelta,
    unsubscribe: function() {
      var _this = this;

      if (this.locked) {
        throw "can not unsubscribe here";
      }
      return $.ajax({
        url: "/reader/api/0/empty-tag?ck=" + ($.now()),
        type: 'POST',
        data: {
          "s": this.title
        },
        done: function(data) {
          var feed, _i, _len, _ref, _results;

          _ref = _this.get('feeds');
          _results = [];
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            feed = _ref[_i];
            _results.push(App.storage.feeds.remove(feed));
          }
          return _results;
        }
      });
    },
    rename: function(new_name) {
      var old_name,
        _this = this;

      old_name = this.get('title');
      return $.ajax({
        url: "/reader/api/0/rename-tag?ck=" + ($.now()),
        type: 'POST',
        data: {
          "s": old_name,
          "dest": new_name
        }
      }).done(function(data) {
        _this.set('title', new_name);
        return _this.get('feeds').forEach(function(feed) {
          var categories;

          categories = feed.get('categories');
          if (_.contains(categories, old_name)) {
            categories[categories.indexOf(old_name)] = new_name;
          }
        });
      });
    },
    addFeed: function(feed) {
      var delta;

      delta = _.pick(this.attributes, 'all', 'unread', 'starred', 'markasread');
      this.get('feeds').add(feed);
      this.mergeDelta(delta);
      return this;
    },
    getSortRank: function() {
      var field, rank, rank_weight, weight;

      rank_weight = {
        markasread: -1,
        read: 2,
        starred: 5
      };
      rank = 0;
      for (field in rank_weight) {
        weight = rank_weight[field];
        rank += this.get(field) * weight;
      }
      return rank;
    }
  });
  Article = Backbone.Model.extend({
    state_read: 'state/read',
    state_markasread: 'state/markasread',
    state_starred: 'state/starred',
    getFeed: function() {
      return new Feed();
    },
    setState: function(state) {
      var categories;

      switch (state) {
        case 'read':
          if (!this.isRead()) {
            categories = _.clone(this.get('categories'));
            categories.push(this.state_read);
            this.set({
              categories: categories
            });
            this.getFeed().increment('read');
          }
          break;
        case 'markasread':
          if (!this.isMarkAsRead()) {
            categories = _.clone(this.get('categories'));
            categories.push(this.state_markasread);
            this.set({
              categories: categories
            });
            this.getFeed().increment('markasread');
          }
          break;
        case 'unread':
          if (this.isMarkAsRead() || this.isRead()) {
            categories = _.clone(this.get('categories'));
            if (this.isMarkAsRead()) {
              categories.splice(categories.indexOf(this.state_markasread), 1);
            }
            if (this.isRead()) {
              categories.splice(categories.indexOf(this.state_read), 1);
            }
            this.set({
              categories: categories
            });
            this.getFeed().increment('markasread');
          }
          break;
        case 'star':
          if (!this.isStarred()) {
            categories = _.clone(this.get('categories'));
            categories.push(this.state_starred);
            this.set({
              categories: categories
            });
            this.getFeed().increment('starred');
          }
          break;
        case 'unstar':
          if (this.isStarred()) {
            categories = _.clone(this.get('categories'));
            categories.splice(categories.indexOf(this.state_starred), 1);
            this.set({
              categories: categories
            });
            this.getFeed().increment('markasread');
          }
          break;
        default:
          console.log(state);
      }
      $.ajax({
        url: "/reader/api/0/subscription/list?ck=" + ($.now()),
        type: 'POST'
      });
      if (obj instanceof Feed) {
        $.ajax({
          url: "/reader/api/0/mark-all-as-read?ck=" + ($.now()),
          type: 'POST',
          data: {
            "s": "state/reading-list"
          }
        });
      }
      return $.ajax({
        url: "/reader/api/0/edit-tag?ck=" + ($.now()),
        type: 'POST',
        data: {
          "a": "state/starred",
          "r": "state/starred",
          "i": obj.id
        }
      });
    },
    toggle: function(state) {
      return true;
    },
    isRead: function() {
      return _.contains(this.get('categories'), this.state_read);
    },
    isMarkAsRead: function() {
      return _.contains(this.get('categories'), this.state_markasread);
    },
    isStarred: function() {
      return _.contains(this.get('categories'), this.state_starred);
    },
    getItemClass: function() {
      var klasses;

      klasses = [];
      if (this.isRead()) {
        klasses.push('read');
      }
      if (this.isStarred()) {
        klasses.push('starred');
      }
      if (this.isMarkAsRead()) {
        klasses.push('markasread');
      }
      return klasses.join(' ');
    }
  });
  ArticleList = Backbone.Collection.extend({
    model: Article,
    initialize: function(items, options) {
      var _this = this;

      this.page_size = options.page_size;
      this.continuation = options.continuation;
      this.stream === options.stream;
      this.loading = false;
      return this.on('article:current-change', function(id) {
        _this.currentId = id;
      });
    },
    getNext: function(id) {
      var index;

      index = -1;
      this.forEach(function(article, i) {
        if (article.get('id') === id) {
          index = i + 1;
          return false;
        }
      });
      if (index < 0) {
        return null;
      }
      if (index === this.length - 1) {
        this.loadMore();
      }
      console.log(index);
      return this.at(index);
    },
    getPrev: function(id) {
      var index;

      index = -1;
      this.forEach(function(article, i) {
        if (article.get('id') === id) {
          index = i - 1;
          return false;
        }
      });
      if (index < 0) {
        return null;
      }
      console.log(index);
      return this.at(index);
    },
    loadMore: function(onload) {
      this.loading = true;
      return App.storage.getItemsRemote(this, function() {
        this.loading = false;
        onload && onload();
      });
    },
    isLoading: function() {
      return this.loading;
    }
  });
  LabelList = Backbone.Collection.extend({
    model: Label,
    initialize: function() {},
    comparator: function(a, b) {
      var rank_a, rank_b;

      if (a.id === App.all_label_id) {
        return -1;
      }
      if (b.id === App.all_label_id) {
        return 1;
      }
      if (a.id === App.mutes_label_id) {
        return 1;
      }
      if (b.id === App.mutes_label_id) {
        return -1;
      }
      if (a.get('unreaded') === 0 && b.get('unreaded') > 0) {
        return 1;
      }
      if (a.get('unreaded') > 0 && b.get('unreaded') === 0) {
        return -1;
      }
      rank_a = a.getSortRank();
      rank_b = b.getSortRank();
      if (rank_a < rank_b) {
        return 1;
      }
      if (rank_a > rank_b) {
        return -1;
      }
      if (a.get('title') === b.get('title')) {
        return 0;
      } else if (a.get('title') > b.get('title')) {
        return 1;
      } else {
        return -1;
      }
    }
  });
  FeedList = Backbone.Collection.extend({
    model: Feed,
    initialize: function() {},
    comparator: function(a, b) {
      var rank_a, rank_b;

      if (a.get('mute') && !b.get('mute')) {
        return 1;
      }
      if (!a.get('mute') && b.get('mute')) {
        return -1;
      }
      if (a.get('unread') === 0 && b.get('unread') > 0) {
        return 1;
      }
      if (a.get('unread') > 0 && b.get('unread') === 0) {
        return -1;
      }
      rank_a = a.getSortRank();
      rank_b = b.getSortRank();
      if (rank_a < rank_b) {
        return 1;
      }
      if (rank_a > rank_b) {
        return -1;
      }
      if (a.get('title') === b.get('title')) {
        return 0;
      } else if (a.get('title') > b.get('title')) {
        return 1;
      } else {
        return -1;
      }
    }
  });
  IndexItemView = Backbone.Marionette.ItemView.extend({
    template: '#index-item-template',
    attributes: function() {
      return {
        'class': 'index-item' + this.model.getItemClass()
      };
    },
    templateHelpers: {
      prettyDate: function(time) {
        return _.prettyDate(time);
      },
      getSummaryText: function(limit) {
        return _.truncate(this.summaryText, limit);
      }
    },
    events: {
      'click': 'clicked'
    },
    clicked: function(event) {
      if ($(event.target).hasClass('star')) {
        event.stopPropagation();
        if (this.$el.hasClass('starred')) {
          return this.model.mark('unstar');
        } else {
          return this.model.mark('star');
        }
      } else if ($(event.target).hasClass('check')) {
        event.stopPropagation();
        if (this.$el.hasClass('read') || this.$el.hasClass('markasread')) {
          return this.model.mark('unread');
        } else {
          return this.model.mark('markasread');
        }
      } else {
        event.preventDefault();
        App.router.navigate('#item/' + this.model.get('id'), {
          trigger: true,
          replace: window.location.hash.indexOf('#item/') === 0
        });
        return $('.wrapper2').removeClass('on');
      }
    },
    modelEvents: {
      'change': 'changed'
    },
    changed: function() {
      var newCategories, oldCategories;

      newCategories = this.model.get('categories');
      oldCategories = this.model.previous('categories');
      if (newCategories.indexOf('state/starred') >= 0 && oldCategories.indexOf('state/starred') < 0) {
        this.$el.addClass('starred');
      }
      if (newCategories.indexOf('state/starred') < 0 && oldCategories.indexOf('state/starred') >= 0) {
        this.$el.removeClass('starred');
      }
      if (newCategories.indexOf('state/read') >= 0 && oldCategories.indexOf('state/read') < 0) {
        this.$el.addClass('read');
      }
      if (newCategories.indexOf('state/read') < 0 && oldCategories.indexOf('state/read') >= 0) {
        this.$el.removeClass('read');
      }
      if (newCategories.indexOf('state/markasread') >= 0 && oldCategories.indexOf('state/markasread') < 0) {
        this.$el.addClass('markasread');
      }
      if (newCategories.indexOf('state/markasread') < 0 && oldCategories.indexOf('state/markasread') >= 0) {
        return this.$el.removeClass('markasread');
      }
    }
  });
  IndexListView = Backbone.Marionette.CollectionView.extend({
    initialize: function() {
      var scroller,
        _this = this;

      this.loading = false;
      this.collection.on('article:current-change', function(id) {
        var cy, item, itemHeight, itemId, itemTop, outerHeight, scrollTop, scroller, sy, totalHeight;

        if (!id) {
          return;
        }
        itemId = id;
        item = _this.$el.find('.index-item article[data-id=' + itemId + ']');
        if (!item) {
          return;
        }
        item = item.parent();
        if (!item) {
          return;
        }
        scroller = $(_this.options.scroller);
        if (!scroller) {
          return;
        }
        scrollTop = scroller.scrollTop();
        outerHeight = scroller.outerHeight();
        if (!(outerHeight > 0)) {
          return;
        }
        if (!item.offset()) {
          return;
        }
        that.$el.find('.index-item.current').removeClass('current');
        item.addClass('current');
        itemTop = scrollTop + item.offset().top;
        itemHeight = item.height();
        if (itemTop >= scrollTop + scroller.offset().top && itemTop + itemHeight <= scrollTop + scroller.offset().top + outerHeight) {
          return;
        }
        totalHeight = scroller.get(0).scrollHeight;
        cy = itemTop(+(itemHeight / 2));
        sy = parseInt(cy - outerHeight / 3 - scroller.offset().top);
        sy = Math.max(0, Math.min(sy, totalHeight - outerHeight));
        return scroller.animate({
          scrollTop: sy
        });
      });
      if (this.options && this.options.scroller) {
        scroller = $(this.options.scroller);
        scroller && scroller.bindWithDelay("scroll", function(event) {
          var outerHeight, scrollTop, totalHeight;

          if (_this.collection.isLoading()) {
            return;
          }
          outerHeight = scroller.outerHeight();
          totalHeight = scroller.get(0).scrollHeight;
          scrollTop = scroller.scrollTop();
          if (totalHeight(-(scrollTop + outerHeight) < outerHeight)) {
            return _this.collection.getMore(function() {});
          }
        }, 100);
        scroller && scroller.bindWithDelay("scroll", function(event) {
          console.log('scroll delay');
        }, 1000);
      }
    },
    setStreamFilter: function(name) {
      $('#filter-all').removeClass('active');
      $('#filter-unread').removeClass('active');
      $('#filter-starred').removeClass('active');
      switch (name) {
        case 'state/reading-list':
          return $('#filter-all').addClass('active');
        case 'state/unread':
          return $('#filter-unread').addClass('active');
        case 'state/starred':
          return $('#filter-starred').addClass('active');
        default:
          return $('#filter-all').addClass('active');
      }
    },
    scrollTop: function(n) {
      var scroller;

      scroller = $(this.options.scroller);
      return scroller.scrollTop(n);
    }
  });
  FeedView = Backbone.Marionette.ItemView.extend({
    template: '#feed-item-template',
    tagName: 'li',
    attributes: function() {
      return {
        'class': 'feed-item',
        'data-id': "stream/" + (encodeURIComponent(this.model.id))
      };
    },
    ui: {
      'counter': 'span.title>span.counter',
      'title': 'span.title>span.txt',
      'more': 'i.more',
      'mute': 'i.mute'
    },
    templateHelpers: {
      getCount: function(name) {
        var count;

        count = this[name];
        if (!count) {
          count = 0;
        }
        if (count > 1000) {
          return '1000+';
        } else {
          return "" + count;
        }
      },
      getStreamId: function() {
        return "stream/" + (encodeURIComponent(this.id));
      },
      getMuteClass: function() {
        if (this.mute) {
          return 'on';
        } else {
          return '';
        }
      }
    },
    events: {
      'click': 'clicked'
    },
    clicked: function(event) {
      var feedPanel, url;

      if ($(event.target).hasClass('more')) {
        event.stopPropagation();
        feedPanel = $('#feed-context-panel');
        if (feedPanel.hasClass('on')) {
          return App.vent.trigger('feed-panel:close');
        } else {
          return App.vent.trigger('feed-panel:open', this.model);
        }
      } else if ($(event.target).hasClass('mute')) {
        event.stopPropagation();
        return App.storage.subscriptionEdit(this.model.id, $(event.target).hasClass('on') ? 'unmute' : 'mute');
      } else {
        event.stopPropagation();
        url = '#' + this.templateHelpers.getStreamId.apply(this.model.attributes);
        if (window.location.hash === url) {
          App.vent.trigger('stream:reset', url.substring('#'.length));
        } else {
          App.router.navigate(url, {
            trigger: true
          });
        }
        App.vent.trigger('article:focus');
      }
    },
    modelEvents: {
      'change': 'changed'
    },
    changed: function() {
      var count;

      count = this.templateHelpers.getCount.apply(this.model.attributes, ['unread']);
      this.ui.counter.html("(" + counter + ")");
      this.ui.counter.toggleClass('on', count === '0');
      this.ui.title.html(this.model.get('title'));
      this.ui.mute.toggleClass('on', this.model.get('mute'));
    }
  });
  LabelView = Backbone.Marionette.CompositeView.extend({
    itemView: FeedView,
    itemViewContainer: 'ul.feed-items',
    template: '#label-item-template',
    tagName: 'div',
    className: 'label-item',
    ui: {
      'counter': 'span.title>span.counter',
      'arrow': 'i.arrow',
      'more': 'i.more'
    },
    templateHelpers: {
      getCount: function(name) {
        var count;

        count = this[name];
        if (!count) {
          count = 0;
        }
        if (count > 1000) {
          return '1000+';
        } else {
          return "" + count;
        }
      },
      getStreamId: function() {
        switch (this.id) {
          case '***ALL***':
            return 'stream/' + encodeURIComponent('state/reading-list');
          case '***MUTES***':
            return 'stream/' + encodeURIComponent('state/mute');
          case '***OTHERS***':
            return 'stream/' + encodeURIComponent('label/');
          default:
            return 'stream/' + encodeURIComponent("label/" + this.id);
        }
      }
    },
    initialize: function() {
      this.collection = this.model.get('feeds');
    },
    events: {
      'click': 'clicked'
    },
    clicked: function(event) {
      var labelPanel, url;

      if ($(event.target).hasClass('more')) {
        event.stopPropagation();
        labelPanel = $('#label-context-panel');
        if (labelPanel.hasClass('on')) {
          App.vent.trigger('label-panel:close');
        } else {
          App.vent.trigger('label-panel:open', this.model);
        }
      } else if ($(event.target).hasClass('arrow')) {
        event.stopPropagation();
        this.$el.toggleClass('expanded');
      } else {
        event.stopPropagation();
        url = '#' + this.templateHelpers.getStreamId.apply(this.model.attributes);
        if (window.location.hash === url) {
          App.vent.trigger('stream:reset', url.substring('#'.length));
        } else {
          App.router.navigate(url, {
            trigger: true
          });
        }
        App.vent.trigger('article:focus');
      }
    },
    modelEvents: {
      'change': 'changed'
    },
    changed: function() {
      var counter;

      counter = this.templateHelpers.getCount.apply(this.model.attributes, ['unread']);
      this.ui.counter.html("(" + counter);
      this.ui.counter.toggleClass('on', counter === '0');
    }
  });
  LabelsView = Backbone.Marionette.CollectionView.extend({
    itemView: LabelView,
    setCurrent: function(url) {
      App.labelsView.$el.find('li.current').removeClass('current');
      App.labelsView.$el.find('li[data-id="' + url + '"]').addClass('current');
    }
  });
  ArticleView = Backbone.Marionette.ItemView.extend({
    template: '#article-template',
    initialize: function() {},
    templateHelpers: {
      prettyDate: function(time) {
        return _.prettyDate(time);
      },
      getContent: function() {
        if (this.content && this.content.content) {
          return this.content.content;
        }
        if (this.summary && this.summary.content) {
          return this.summary.content;
        }
        return "";
      },
      getItemClass: function() {
        var klasses;

        klasses = [];
        if (_.contains(this.categories, 'state/read')) {
          klasses.push('read');
        }
        if (_.contains(this.categories, 'state/starred')) {
          klasses.push('starred');
        }
        if (_.contains(this.categories, 'state/markasread')) {
          klasses.push('markasread');
        }
        return klasses.join(' ');
      }
    },
    events: {
      'click div.article-origin': 'originClicked',
      'click a': 'linkClicked'
    },
    originClicked: function(event) {
      var origin;

      return origin = this.model.get('origin');
    },
    onRender: function() {
      this.$el.find('.article-item').toggleClass('read', this.model.isRead()).toggleClass('markasread', this.model.isMarkAsRead()).toggleClass('starred', this.model.isStarred()).find('img').removeAttr('width height');
    }
  });
  AppStorage = Backbone.Marionette.Controller.extend({
    cached_items: new ArticleList([], {
      model: Article,
      url: '',
      page_size: 20,
      continuation: ''
    }),
    initialize: function() {
      var _this = this;

      this.loadSubscriptions();
      if (!this.feeds.length) {
        this.loadSubscriptionsRemote(function() {
          _this.buildLabels();
          _this.saveSubscriptions();
        });
      } else {
        this.buildLabels();
      }
      this.loadItems();
    },
    buildLabels: function() {
      var _this = this;

      this.lables = new LabelList();
      this.allLabel = new Label({
        'id': App.all_label_id,
        'title': 'All',
        'feeds': new FeedList()
      });
      this.othersLabel = new Label({
        'id': App.other_label_id,
        'title': 'Others',
        'feeds': new FeedList()
      });
      this.mutesLabel = new Label({
        'id': App.mutes_label_id,
        'title': 'Mutes',
        'feeds': new FeedList()
      });
      this.labels.add(this.allLabel);
      this.labels.add(this.othersLabel);
      this.labels.add(this.mutesLabel);
      this.feeds.each(function(feed) {
        _this.allLabel.addFeed(feed);
        if (feed.mute) {
          _this.mutesLabel.addFeed(feed);
        }
        if (feed.get('categories') && feed.get('categories').length) {
          _.each(feed.get('categories'), function(category) {
            var label;

            label = this.labels.get(category);
            if (!label) {
              label = new Label({
                id: category,
                title: category,
                feeds: new FeedList()
              });
              this.labels.add(label);
            }
            return label.addFeed(feed);
          }, _this);
        }
      });
      this.labels.forEach(function(label) {
        label.get('feeds').sort();
      });
      this.labels.sort();
      return this;
    },
    feeds: new FeedList(),
    labels: new LabelList(),
    getFeedByStreamId: function(streamId) {
      return this.feeds.get(streamId);
    },
    getFeeds: function() {
      return this.feeds;
    },
    getLabel: function(label_name) {
      return this.labels.get(label_name);
    },
    getLabels: function() {
      return this.labels;
    },
    valid_filters: ['state/reading-list', 'state/unread', 'state/starred'],
    setStreamFilter: function(name) {
      var filter;

      filter = _.contains(this.valid_filters, name) ? name : _.first(this.valid_filters);
      return localStorage.setItem('storage-stream-filter', filter);
    },
    getStreamFilter: function() {
      return localStorage.getItem('storage-stream-filter') || _.first(this.valid_filters);
    },
    setStreamId: function(streamId) {
      return localStorage.setItem('storage-stream-id', streamId);
    },
    getStreamId: function() {
      return localStorage.getItem('storage-stream-id') || _.first(this.valid_filters);
    },
    getCachedItems: function(collection) {
      var cached_items, filter, streamId, t;

      if (!collection) {
        return [];
      }
      streamId = collection.stream;
      filter = this.getStreamFilter();
      cached_items = [];
      t = parseInt($.now() / 1000);
      if (collection.length) {
        t = collection.last().get('updated');
      }
      this.cached_items.each(function(cached_item) {
        var categories;

        if (cached_item.get('updated') > t) {
          return;
        }
        categories = cached_item.get('categories');
        if (streamId.indexOf('lable/') === 0 && !_.contains(categories, streamId)) {
          return;
        }
        if (streamId.indexOf('feed/') === 0 && cached_item.get('origin') !== streamId) {
          return;
        }
        if (streamId.indexOf('state/') === 0) {
          if (streamId === 'state/unread' && (cached_item.isRead() || cached_item.isMarkAsRead())) {
            return;
          }
          if (streamId === 'state/starred' && !cached_item.isStarred()) {
            return;
          }
        }
        if (filter === 'state/unread' && (cached_item.isRead() || cached_item.isMarkAsRead())) {
          return;
        }
        if (filter === 'state/starred' && !cached_item.isStarred()) {
          return;
        }
        cached_items.push(_.pick(cached_item, 'id', 'updated'));
      }, this);
      cached_items.sort(function(a, b) {
        return b.updated - a.updated;
      });
      return _.head(cached_items, collection.page_size * 2);
    },
    getItemsRemote: function(collection, callback) {
      var filter, p, qs, qsa, url, _i, _len,
        _this = this;

      qsa = [];
      url = '/reader/api/0/stream/contents/' + collection.stream;
      url = "var/data/reader_items.json";
      qsa.push(['stream', collection.stream]);
      qsa.push(['n', collection.page_size]);
      qsa.push(['ck', $.now()]);
      if (collection.continuation) {
        qsa.push(['c', collection.continuation]);
      }
      filter = this.getStreamFilter();
      if (filter && filter !== _.first(this.valid_filters)) {
        qsa.push(['filter', filter]);
      }
      qs = [];
      for (_i = 0, _len = qsa.length; _i < _len; _i++) {
        p = qsa[_i];
        qs.push("" + p[0] + "=" + p[1]);
      }
      url += '?' + qs.join('&');
      return $.ajax({
        url: url,
        type: 'POST',
        beforeSend: function(xhr) {
          xhr.overrideMimeType("application/json; charset=UTF-8");
        },
        data: JSON.stringify({
          version: '1.0',
          items: this.getCachedItems(collection)
        })
      }).done(function(data) {
        var article, attributes, categories, diff, i, itemIsChanged, itemsAreChanged, old_catetories;

        itemsAreChanged = false;
        console.log(data);
        for (i in data) {
          attributes = data[i];
          if (!attributes.cached) {
            article = new Article(attributes);
            _this.cached_items.add(article);
            if (collection) {
              collection.add(article);
            }
            itemsAreChanged = true;
          } else {
            article = _this.cached_items.get(attributes.id);
            itemIsChanged = false;
            if (attributes.categories) {
              old_catetories = article.get('categories');
              categories = attributes.categories;
              diff = _.diff(old_catetories, categories);
              if (diff.added.length || diff.removed.length) {
                itemIsChanged = true;
              }
              if (itemIsChanged) {
                article.set({
                  categories: categories
                });
              }
            }
          }
        }
        if (collection) {
          collection.continuation = data.continuation;
        }
        if (itemsAreChanged) {
          _this.saveItems();
        }
        console.log(_this.cached_items);
      });
    },
    loadSubscriptionsRemote: function(callback) {
      var _this = this;

      $.ajax({
        url: "var/data/subscriptions.json?ck=" + ($.now()),
        type: 'POST',
        beforeSend: function(xhr) {
          xhr.overrideMimeType("application/json; charset=UTF-8");
        }
      }).done(function(data) {
        _this.feeds.reset(data);
        callback && callback();
      });
    },
    loadSubscriptions: function() {
      return this.feeds.reset(JSON.parse(localStorage.getItem('subscriptions')));
    },
    loadItems: function() {
      return this.cached_items.reset(JSON.parse(localStorage.getItem('item')));
    },
    saveSubscriptions: function() {
      localStorage.removeItem('subscriptions');
      localStorage.setItem('subscriptions', JSON.stringify(this.feeds.toJSON()));
    },
    getItem: function(id) {
      return this.cached_items.get(id);
    },
    saveItems: function() {
      var items, max_cache_items;

      localStorage.removeItem('item');
      items = this.cached_items.toJSON();
      console.log(items);
      max_cache_items = 100;
      if (items.length > max_cache_items) {
        items.sort(function(a, b) {
          return b.updated - a.updated;
        });
        items.length = max_cache_items;
      }
      return localStorage.setItem('item', JSON.stringify(items));
    },
    quickSubscribe: function(query, callback) {
      return $.ajax({
        url: "/reader/api/0/subscription/quickadd?ck=" + ($.now()),
        type: 'POST',
        data: {
          "quickadd": query
        }
      }).done(function(data) {
        return callback && callback(data);
      });
    }
  });
  AppRouter = Backbone.Router.extend({
    initialize: function() {
      this.routesHit = 0;
      Backbone.history.on('route', function() {
        this.routesHit++;
      }, this);
      this.mark_timer = null;
    },
    next: function() {},
    routes: {
      'item/:id': "itemView",
      'stream/*query': "streamView"
    },
    itemView: function(id) {
      App.vent.trigger('article:change', id);
    },
    streamView: function(stream) {
      if (App.indexList.stream === stream) {
        App.indexList.trigger('article:current-change', App.indexList.currentId);
        return;
      }
      App.vent.trigger('stream:reset', stream);
    },
    back: function() {
      if (this.routesHit) {
        window.history.back();
      } else {
        this.navigate(buildUrlHash('stream', 'state/reading-list'), {
          trigger: true,
          replace: true
        });
      }
    }
  });
  buildUrlHash = function(prefix, path) {
    return "#" + prefix + "/" + (encodeURIComponent(path));
  };
  window.App = App = new Backbone.Marionette.Application();
  _.extend(App, {
    all_label_id: '***ALL***',
    other_label_id: '***OTHERS***',
    mutes_label_id: '***MUTES***',
    _: function(msg_id) {
      return msg_id;
    }
  });
  App.hot_keys = {
    'k': {
      'desc': '向上滚动',
      'alias': 'left',
      'handler': function() {
        App.vent.trigger('article:next', App.articleView.model.id);
        return false;
      }
    },
    'j': {
      'desc': '向下滚动',
      'alias': 'right',
      'handler': function() {
        App.vent.trigger('article:prev', App.articleView.model.id);
        return false;
      }
    },
    'f1': {
      name: 'F1/?',
      alias: 'shit+/',
      'desc': '获取本帮助',
      'handler': function() {
        App.vent.trigger('help:shortcuts');
        return false;
      }
    },
    's': {
      'desc': '标记喜欢/不喜欢',
      'handler': function() {
        App.articleView.model.toggle('star');
        return false;
      }
    },
    'a': {
      'desc': '标记已读/未读',
      'handler': function() {
        App.articleView.model.toggle('markasread');
        return false;
      }
    },
    '/': {
      'desc': '搜索',
      'handler': function() {
        return false;
      }
    }
  };
  App.addInitializer(function(options) {
    var streamFilter, streamId;

    App.router = new AppRouter();
    App.storage = new AppStorage();
    streamId = App.storage.getStreamId();
    streamFilter = App.storage.getStreamFilter();
    App.labelsView = new LabelsView({
      el: '#label-view',
      collection: App.storage.getLabels()
    });
    App.labelsView.render();
    App.indexList = new ArticleList([], {
      stream: streamId,
      page_size: 20,
      continuation: ''
    });
    App.indexView = new IndexListView({
      el: "#index-view",
      itemView: IndexItemView,
      collection: App.indexList,
      'scroller': '.app-view aside.wrapper2'
    });
    App.indexView.render();
    App.storage.setStreamFilter(streamFilter);
    App.indexView.setStreamFilter(streamFilter);
    App.vent.trigger('stream:reset');
    App.vent.on('stream:reset', function(stream) {
      if (stream) {
        App.indexList.stream = stream;
      }
      App.indexList.continuation = null;
      App.indexList.reset();
      App.indexView.scrollTop(0);
      App.indexList.loadMore(function() {
        if (App.indexList.length > 0) {
          App.vent.trigger('article:change', App.indexList.at(0).id);
        }
      });
      App.labelsView.setCurrent('stream/' + App.indexList.url);
    });
    App.vent.on('article:change', function(id) {
      var newArticle;

      console.log(id);
      newArticle = App.storage.getItem(id);
      console.log(newArticle);
      App.articleView = new ArticleView({
        el: '#article-view',
        model: newArticle,
        'scroller': '.app-view section.wrapper3'
      });
      App.articleView.render();
      App.indexList.trigger('article:current-change', id);
      document.title = newArticle.get('title');
    });
    App.vent.on('article:prev', function(id) {
      var article, url;

      if (!App.indexList) {
        return;
      }
      article = App.indexList.getPrev(id);
      if (article) {
        url = "#item/" + (article.get('id'));
        App.router.navigate(url, {
          trigger: true,
          replace: true
        });
      }
    });
    App.vent.on('article:next', function(id) {
      var article, url;

      if (!App.indexList) {
        return;
      }
      article = App.indexList.getNext(id);
      if (article) {
        url = "#item/" + (article.get('id'));
        App.router.navigate(url, {
          trigger: true,
          replace: true
        });
      }
    });
    Backbone.history.start();
  });
  App.vent.on('help:shortcuts', function() {
    console.log('hotkeys config:', App.hot_keys);
  });
  App.addInitializer(function(options) {
    _.each(App.hot_keys, function(key, key_config) {
      var alias_key, _i, _len, _ref;

      console.log(key);
      $(document).bind('keydown', key, key_config.handler);
      if (key_config.alias) {
        console.log(key_config.alias.split(' '));
        _ref = key_config.alias.split(' ');
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          alias_key = _ref[_i];
          $(document).bind('keydown', alias_key, key_config.handler);
        }
      }
    });
  });
  App.start();
});
